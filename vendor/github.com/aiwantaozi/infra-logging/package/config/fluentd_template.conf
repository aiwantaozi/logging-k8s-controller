<source>
    @type  tail
    path  /var/log/containers/*.log
    pos_file  /fluentd/etc/fluentd-kubernetes.pos
    time_format  %Y-%m-%dT%H:%M:%S
    tag  kubernetes.*
    format  json
    read_from_head  true
</source>
<source>
    @type  monitor_agent
    bind  0.0.0.0
    port  24220
</source>

{{range $i, $source := .sources -}}
<source>
  @type tail
  path {{$source.InputPath}}
  pos_file {{$source.InputPath}}.pos
  tag services.*
  format {{$source.InputFormat}}
</source>
{{end -}}

<filter  kubernetes.**>
    type  kubernetes_metadata
    merge_json_log  true
    preserve_json_log  true
</filter>
<filter  kubernetes.**>
    @type  record_transformer
    enable_ruby  true
    <record>
        kubernetes_namespace_container_name $${record["kubernetes"]["namespace_name"]}.$${record["kubernetes"]["container_name"]}     
    </record>
</filter>
#  retag  based  on  the  container  name  of  the  log  message
<match  kubernetes.**>
    @type  rewrite_tag_filter
    rewriterule1  kubernetes_namespace_container_name    ^(.+)$$  kubernetes.$$1
</match>
    #  Remove  the  unnecessary  field  as  the  information  is  already  available  on
    #  other  fields.
<filter  kubernetes.**>
    @type  record_transformer
    remove_keys  kubernetes_namespace_container_name
</filter>
<match  kubernetes.**>         
    @type  copy        
    {{range $i, $store := .stores -}}
    <store>
        @type  {{$store.Target.OutputType}}
        host  {{$store.Target.OutputHost}}           
        port  {{$store.Target.OutputPort}}
        logstash_format  true
        logstash_prefix  {{$store.Target.OutputLogstashPrefix}}
        logstash_dateformat  {{$store.Target.OutputLogstashDateformat}}
        include_tag_key  true
        type_name  access_log
        tag_key {{$store.Target.OutputTagKey}}
        flush_interval  1s
        {{ if $store.Secret.Label -}}
        <{{$store.Secret.Label}}>
        {{end -}}
            {{range $j, $dt := $store.Secret.Data -}}
                {{$j}} {{$dt}}
            {{end -}}
        {{ if $store.Secret.Label -}}
        </{{$store.Secret.Label}}>
        {{end -}}
    </store>
    {{end -}}
</match>
<match  services.**>         
    @type  copy        
    {{range $i, $store := .stores -}}
    <store>
        @type  {{$store.Target.OutputType}}
        host  {{$store.Target.OutputHost}}           
        port  {{$store.Target.OutputPort}}
        logstash_format  true
        logstash_prefix  {{$store.Target.OutputLogstashPrefix}}
        logstash_dateformat  {{$store.Target.OutputLogstashDateformat}}
        include_tag_key  true
        type_name  access_log
        tag_key {{$store.Target.OutputTagKey}}
        flush_interval  1s
        {{ if $store.Secret.Label -}}
        <{{$store.Secret.Label}}>
        {{end -}}
            {{range $j, $dt := $store.Secret.Data -}}
                {{$j}} {{$dt}}
            {{end -}}
        {{ if $store.Secret.Label -}}
        </{{$store.Secret.Label}}>
        {{end -}}
    </store>
    {{end -}}
</match>